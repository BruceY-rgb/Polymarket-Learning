# 时间过滤功能使用说明

## 概述

本项目已添加时间范围过滤功能，默认只获取最近半年（180天）的数据，以减少数据下载量和存储空间。

## 修改内容

### 1. 文件修改

- **update_utils/update_markets.py** - 添加了市场数据的时间过滤
- **update_utils/update_goldsky.py** - 添加了交易数据的时间过滤
- **update_all.py** - 更新了主脚本支持命令行参数

### 2. 主要功能

- 默认时间范围：180天（半年）
- 可通过参数调整时间范围
- 支持命令行参数自定义天数
- 自动跳过超出时间范围的数据

## 使用方法

### 方法1：使用默认设置（180天）

```bash
python update_all.py
```

### 方法2：自定义时间范围

```bash
python update_all.py <天数>
```

例如，获取最近30天的数据：
```bash
python update_all.py 30
```

### 方法3：单独调用模块

```python
from update_utils.update_markets import update_markets
from update_utils.update_goldsky import update_goldsky

# 获取最近90天的数据
update_markets(days_limit=90)
update_goldsky(days_limit=90)
```

## 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| days_limit | int | 180 | 时间范围限制（天数） |

## 输出示例

```
==================================================
开始更新数据（时间范围: 最近 180 天）
==================================================

正在更新市场数据
时间范围限制: 最近 180 天
起始时间: 2025-08-02 07:50:33 UTC (timestamp: 1754121033)
在偏移 0 处获取批次...
...
```

## 兼容性

- 向后兼容：不指定天数参数时，使用默认值180天
- 现有代码无需修改即可使用新功能
- 支持任意的天数设置（1-365天或更多）

## 注意事项

1. **时间计算**：使用UTC时间进行计算
2. **数据过滤**：自动跳过时间范围外的数据
3. **性能优化**：减少API请求量和数据传输
4. **存储优化**：减少本地存储空间占用

## 技术细节

### 时间过滤实现

1. **市场数据过滤**：
   - API参数：`createdAt_min` 过滤起始时间
   - 客户端过滤：检查 `createdAt` 字段跳过旧数据

2. **交易数据过滤**：
   - GraphQL查询：修改 `where` 条件添加时间过滤
   - 游标管理：从起始时间开始恢复

### 错误处理

- 兼容多种时间格式（ISO字符串、时间戳）
- 自动跳过无法解析的时间数据
- 向后兼容：如果时间过滤失败，继续处理数据